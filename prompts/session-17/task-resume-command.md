# Task: Add run-agent task resume command

## Context

You are working in the conductor-loop project at /Users/jonnyzzz/Work/conductor-loop.

The project has a `run-agent task` command that runs an agent with the Ralph loop. When a task fails or exceeds max restarts, the task directory is preserved. Per the design decisions (QUESTIONS.md Q4):

> "For resume capability, a future `run-agent task resume --task <id>` command should reset the restart counter and continue from the same task directory."

## Goal

Add a `resume` subcommand to `run-agent task`:

```bash
./bin/run-agent task resume \
  --project my-project \
  --task task-20260220-190000-my-task \
  --agent claude \
  --root ./runs
```

### Behavior

1. Verify the task directory exists at `<root>/<project>/<task>/`
2. Verify TASK.md exists in the task directory (it was written when the task was originally created)
3. Run `RunTask()` with:
   - Same project, task, root, agent
   - `attach_mode: "resume"` (adds restart prefix to prompt)
   - `max_restarts: opts.MaxRestarts` (from flag, default 3)
   - `prompt: ""` (uses existing TASK.md)
4. Succeeds if the task eventually creates DONE file; errors if max restarts exceeded

### Implementation Plan

1. In `cmd/run-agent/main.go`: add `resumeCmd` as a subcommand of `taskCmd`:
   - Or alternatively, add `--resume` flag to `task` command that sets attach_mode="resume" and skips task creation checks

2. The simplest approach: add a `--resume` flag to `run-agent task` command:
   - When `--resume` is set and `--task` is provided, set attach_mode="resume"
   - RunTask will find existing TASK.md and prepend the restart prefix
   - Print "Resuming task: <task-id>" to stderr

3. Alternatively, create a dedicated `resume` subcommand (cleaner UX):
   ```bash
   run-agent task resume --project p --task t --agent claude --root ./runs
   ```

**Preferred approach**: Create a dedicated subcommand for clarity.

### Where to Look

- `cmd/run-agent/main.go` — main command registration
- `internal/runner/task.go` — RunTask() function and TaskOptions struct
- `internal/runner/task_test.go` — existing tests to understand patterns

### TaskOptions struct (in internal/runner/task.go)

The key fields:
```go
type TaskOptions struct {
    ProjectID      string
    TaskID         string
    AgentType      string
    Root           string
    CWD            string
    Prompt         string
    PromptPath     string
    MaxRestarts    int
    RestartDelay   time.Duration
    AttachMode     string  // "create", "attach", "resume"
    // ... other fields
}
```

With `AttachMode: "resume"`, RunTask:
- Does NOT create a new TASK.md (uses existing one)
- Adds restart prefix ("Continue working on the following:\n\n") to the prompt on each run

### Implementation

Add to `cmd/run-agent/main.go`:

```go
func newTaskResumeCmd() *cobra.Command {
    var (
        projectID  string
        taskID     string
        agentType  string
        root       string
        maxRestarts int
        config     string
    )
    cmd := &cobra.Command{
        Use:   "resume",
        Short: "Resume a stopped or failed task",
        RunE: func(cmd *cobra.Command, args []string) error {
            // validate task dir exists
            // run RunTask with AttachMode="resume"
        },
    }
    // add flags
    return cmd
}
```

Then register: `taskCmd.AddCommand(newTaskResumeCmd())`

### Tests

Add to `cmd/run-agent/main_test.go` or a new `resume_test.go`:
1. Test that resume fails if task directory doesn't exist
2. Test that resume fails if TASK.md doesn't exist in the task dir
3. Test that resume with valid task dir runs successfully (use a stub agent that creates DONE file)

Look at existing tests like `TestTaskPrintsAutoGeneratedTaskID` for patterns on testing CLI commands.

## Quality Gates

Before creating DONE file:
1. `go build ./...` — must pass
2. `go test ./cmd/run-agent/...` — must pass
3. `go test -race ./internal/runner/...` — must pass

Also run: `./bin/run-agent task --help` to verify the resume subcommand appears.

## Output

Write a summary to output.md describing what you implemented, what files you changed, and the test results.

After quality gates pass, create a DONE file in $TASK_FOLDER to signal completion.
