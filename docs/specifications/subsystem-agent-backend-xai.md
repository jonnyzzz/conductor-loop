# Agent Backend: xAI

## Overview
Defines the native xAI backend integration for run-agent. xAI is invoked via REST API (not CLI wrappers).

## Goals
- Provide a stable adapter for xAI-backed agent runs.
- Stream output progressively for real-time monitoring.

## Non-Goals
- Implementing advanced xAI-specific features beyond text completion.

## Invocation (REST)
- run-agent sends a prompt to the xAI chat completions API using an API key from config.hcl.
- Default base URL: `https://api.x.ai`.
- Default endpoint: `/v1/chat/completions` (resolved from base URL).
- Default model: `grok-4` unless overridden.
- Streaming is enabled; the adapter emits tokens to stdout as they arrive.

## I/O Contract
- Input: prompt text (from prompt.md).
- Output: plain text response written to stdout (captured to agent-stdout.txt). `output.md` is generated by the runner from the captured stdout.
- Errors: logged to agent-stderr.txt; non-zero exit code for failures.
- Streaming behavior: SSE `data:` chunks are parsed and written to stdout as they arrive.

## Environment / Config
- Tokens/credentials configured in `config.hcl`:
  ```hcl
  agent "xai" {
    token = "..."                          # Inline token
    # OR: token = "@/path/to/token.txt"     # @file reference (preferred)
    # OR: token_file = "~/.config/xai/token"  # File-based field (alternative)

    # Optional REST settings:
    # base_url = "https://api.x.ai"         # Base URL override
    # model = "grok-4"                      # Model override
  }
  ```
- Runner automatically injects token as `XAI_API_KEY` environment variable (hardcoded mapping).
- REST adapter also honors environment overrides:
  - `XAI_API_KEY`
  - `XAI_BASE_URL`, `XAI_API_BASE`, `XAI_API_ENDPOINT`
  - `XAI_MODEL`
- When config is loaded, run-agent validates agent types and rejects unknown backends.

## Implementation Details (REST/SSE)

### HTTP Request Format
- **URL**: `{base_url}/v1/chat/completions`
- **Method**: POST
- **Headers**:
  - `Authorization: Bearer {XAI_API_KEY}`
  - `Content-Type: application/json`
  - `Accept: text/event-stream`
  - `User-Agent: conductor-loop/xai`
- **Body**:
  ```json
  {
    "model": "grok-4",
    "messages": [{"role": "user", "content": "..."}],
    "stream": true
  }
  ```

### SSE Stream Parsing
- **Format**: Server-Sent Events with `data:` prefix
- **Termination signal**: `data: [DONE]`
- **Content extraction**: `choices[0].delta.content`, `choices[0].message.content`, or `choices[0].text`
- **Fallback**: If response is not SSE, parse full JSON response and emit the final content.

## Related Files
- subsystem-runner-orchestration.md
- subsystem-env-contract.md
