# Agent Backend: Perplexity

## Overview
Defines the native Perplexity backend integration for run-agent. Unlike the others, it is a **REST-only agent** and does not wrap a CLI tool.

## Goals
- Provide a stable adapter for Perplexity-backed agent runs.
- Align prompt/input/output handling with other agent backends.

## REST API Interaction
- **Endpoint**: `https://api.perplexity.ai/chat/completions` (default).
- **Model**: `sonar-pro` (recommended default). The `sonar-reasoning` model was deprecated by Perplexity AI and returns HTTP 400. Override via the `model` field in config.
- **Method**: `POST`.
- **Headers**:
    - `Authorization: Bearer <token>`
    - `Content-Type: application/json`
    - `Accept: text/event-stream` (SSE)

## I/O Contract
- **Input**: Prompt text (from prompt.md).
- **Output**: Plain text response written to stdout (captured to `agent-stdout.txt`). `output.md` is generated by the runner from the captured stdout.
- **Streaming**:
    - **Protocol**: Server-Sent Events (SSE).
    - **Behavior**: Stream `data:` events; parse `choices[0].delta.content`; handle `[DONE]`.
    - **Citations**: Collected from `citations` or `search_results` fields in the final chunks and appended to the output as a "Sources:" block.

## Environment / Config
- Tokens/credentials configured in `~/.run-agent/conductor-loop.hcl` (HCL) or `config.yaml` (YAML):
  ```hcl
  perplexity {
    token_file = "~/.perplexity"
    model      = "sonar-pro"    # override default; sonar-reasoning is deprecated
  }
  ```
  ```yaml
  agents:
    perplexity:
      type: perplexity
      token_file: ~/.perplexity
      model: sonar-pro
  ```
- `model` field overrides the hard-coded default in `internal/agent/perplexity/perplexity.go`.
- Runner automatically injects token as `PERPLEXITY_API_KEY` environment variable.
- Backend selection uses same round-robin/weights as other agent types.

## Implementation Status
- **Status**: Active.
- **Go Package**: `internal/agent/perplexity`.
- **Runner Logic**: `isRestAgent("perplexity")` returns true; instantiated via `NewPerplexityAgent`.
- **Type String**: `"perplexity"`.
