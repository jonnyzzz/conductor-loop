# Storage & Data Layout Subsystem

## Overview
Defines the on-disk layout under `~/.run-agent/runs` (default) for projects, tasks, and individual agent runs. This layout is the source of truth for monitoring, recovery, and auditability.

## Runs Root Directory

The runs root directory is determined by the following resolution order:

1. **`--root` flag** — explicit override for testing / development only.
2. **`storage.runs_dir` in config** — canonical override via `~/.run-agent/conductor-loop.hcl`:
   ```hcl
   storage {
     runs_dir = "~/my-runs"
   }
   ```
3. **Default:** `~/.run-agent/runs`

All CLI subcommands (`list`, `status`, `watch`, `gc`, `output`, `bus`, `facts`, `task`, `job`, etc.) use the same resolution logic implemented in `config.ResolveRunsDir`. If the config file exists but is malformed, all commands fail with an error — there is no silent fallback.

## Goals
- Provide a predictable, human-readable structure.
- Persist task state, facts, and message bus history.
- Allow reconstruction of run trees from disk without external DB.
- Keep project-level and task-level message buses separate.

## Non-Goals
- Long-term archival or retention policies beyond "keep everything".
- Storing large binary artifacts.

## Responsibilities
- Define directory layout and naming conventions.
- Define file formats for run metadata, facts, and state files.
- Specify how agents read/write state and facts.
- Clarify that config.hcl is global only (no per-project/task config files).

## Directory Layout
Base root (`~/.run-agent/runs` by default):

~/.run-agent/
  conductor-loop.hcl      ← user home config (not inside runs/)
  runs/                   ← default runs root (configurable via storage.runs_dir)
  binaries/               ← versioned binary cache
<runs_root>/
  <project>/
    PROJECT-MESSAGE-BUS.md
    home-folders.md
    FACT-<timestamp>-<name>.md
    task-<timestamp>-<slug>/   # task_id folder (caller-provided; recommended naming below)
      TASK.md
      TASK_STATE.md
      DONE
      TASK-MESSAGE-BUS.md
      TASK-FACTS-<timestamp>.md
      ATTACH-<timestamp>-<name>.<ext>
      runs/
        <run_id>/
          run-info.yaml
          prompt.md
          output.md
          agent-stdout.txt
          agent-stderr.txt

## Naming Conventions
- Timestamp format (UTC): `YYYYMMDD-HHMMSSffff-PID-SEQ` (Go layout `20060102-1504050000`; f = 1/10,000s).
  - `ffff` = 4-digit fractional seconds.
  - `PID` = OS process ID.
  - `SEQ` = process-local atomic counter (starts at 1; prevents same-process same-millisecond collisions).
  - Example: `20260223-2048580000-66788-1`
- run_id: same format as timestamp (generated by run-agent).
- Project ID: recommended Java Identifier rules; no length limit (not enforced by runner).
- Task folder: `task-<timestamp>-<slug>` is the recommended pattern, but task_id is caller-provided. Slug rules: lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash.
- FACT files: FACT-<timestamp>-<name>.md.
- Task facts: TASK-FACTS-<timestamp>.md.
- Attachments: ATTACH-<timestamp>-<name>.<ext> stored in the task folder.

## File Formats
### run-info.yaml
- YAML with lower-case keys (not HCL).
- Encoding: UTF-8 without BOM (strict enforcement).
- Required fields (v1): run_id, project_id, task_id, agent, pid, pgid, start_time, status, exit_code, end_time.
- Lineage fields: parent_run_id and previous_run_id (empty or omitted for root/first run).
- exit_code = -1 while running; end_time = zero value while running. Both fields are always present.
- Paths are absolute: cwd, prompt_path, output_path, stdout_path, stderr_path.
- Optional fields:
  - process_ownership: `"managed"` (default) or `"external"`.
  - commandline (full command used to start the agent).
  - error_summary (human-readable error description on failure).
  - agent_version (detected CLI version string; omitted for REST agents or if detection fails).
- Detailed schema specification: see subsystem-storage-layout-run-info-schema.md.

### TASK_STATE.md
- Free-text summary maintained by root agent.
- Encoding: UTF-8 without BOM (strict enforcement).
- Short, current status only (not a log).
- Written by root agent only; update via temp write + atomic rename.
- New runs should read TASK_STATE.md on start to restore context.
- Some prompts may refer to STATE.md, but the canonical file name is TASK_STATE.md.

### DONE
- Empty marker file created by root agent when task is complete.
- Deleting DONE restarts the Ralph loop on next run.

### FACT-*.md and TASK-FACTS-*.md
- Encoding: UTF-8 without BOM (strict enforcement).
- YAML front matter required:
  - created_at, scope (task|project), run_id, title
- Body is Markdown.
- scope can also be global; global facts live under ~/run-agent/global/.

### ATTACH-*.ext
- Binary or text artifacts stored at task folder root.
- attachment_path in message bus entries is relative to the task folder.
- Names use the canonical timestamp + short description: ATTACH-<timestamp>-<name>.<ext>.

### home-folders.md
- YAML format:
  - project_root
  - source_folders[]
  - additional_folders[]
- Each folder entry includes a short text explanation.

## Message Bus Storage
- Single append-only file per scope:
  - PROJECT-MESSAGE-BUS.md
  - TASK-MESSAGE-BUS.md
- Format managed by run-agent bus tooling (see Message Bus Tooling).
- Auto-rotation: `WithAutoRotate(maxBytes)` rotates on each write when threshold is exceeded. Manual rotation: `run-agent gc --rotate-bus --bus-max-size 10MB`.
- Runner appends RUN_START / RUN_STOP entries with run_id to TASK-MESSAGE-BUS.md (start/stop log).
- Message attachments referenced by attachment_path live in the task folder (see Attachments naming).
- Locking: writes use exclusive flock (Unix) / LockFileEx (Windows); reads are lockless.

## Lifecycle
- Project directory created on first task creation.
- Task directory created by run-agent task.
- Run directory created by run-agent per execution.
- Facts are appended by creating new FACT files.
- TASK_STATE.md overwritten by root agent each cycle.

## Retention / Cleanup
- No cleanup or pruning required yet.

## Constraints
- Symlinks/hardlinks inside the storage tree are not allowed.
- No host_id segmentation; runs live under project/task only.
- No size limits enforced for output.md, TASK_STATE.md, or FACT files.
- All text files (TASK.md, TASK_STATE.md, output.md, prompt.md, stdout/stderr logs, FACT files, MESSAGE-BUS files) use strict UTF-8 encoding without BOM.

## Notes
- UI reads only from this layout + message bus files.
- RUN_START and RUN_STOP events live in the task message bus; run-info.yaml is the canonical per-run audit record.
- UI defaults to output.md; raw stdout/stderr are available via a log toggle.
