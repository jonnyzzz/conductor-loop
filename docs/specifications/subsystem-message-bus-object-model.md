# Message Bus Object Model

## Overview
This document defines the canonical message object model used by `internal/messagebus`.
The source of truth is the current Go implementation in:
- `internal/messagebus/messagebus.go`
- `internal/messagebus/msgid.go`

## Message Record Format
Each message is serialized as:
1. YAML front matter between `---` delimiters.
2. Optional body text after the closing `---`.

Example:
```yaml
---
msg_id: MSG-20260223-191710-184887000-PID67946-0001
ts: 2026-02-23T19:17:10Z
type: FACT
project_id: conductor-loop
task_id: task-20260223-214858-docs-specs-bus-api
run_id: 20260223-2048580000-66789-1
issue_id: MSG-20260223-191710-184887000-PID67946-0001
parents:
  - msg_id: MSG-20260223-191500-000000001-PID01234-0001
    kind: depends_on
    meta:
      reason: blocked
links:
  - url: https://example.invalid/context
    label: context
    kind: reference
meta:
  source: runner
---
message body text
```

## Canonical Fields
| Field | Type | Required | Notes |
| --- | --- | --- | --- |
| `msg_id` | string | generated on append | Generated by `GenerateMessageID()` before write. |
| `ts` | timestamp | generated on append if missing | Normalized to UTC. |
| `type` | string | yes | Must be non-empty; no allowlist enforcement. |
| `project_id` | string | yes | Must be non-empty. |
| `task_id` | string | no | Task scope when applicable. |
| `run_id` | string | no | Run scope when applicable. |
| `issue_id` | string | no | Alias field for issue threads. |
| `parents` | `[]Parent` | no | Structured parent references (backward-compatible parsing). |
| `links` | `[]Link` | no | Advisory links. |
| `meta` | `map[string]string` | no | Free-form key/value metadata. |
| `body` | string | no | Stored after front matter (not a YAML header field). |

## Parent Model
`parents` supports two input forms:
1. Legacy string list.
2. Structured object list.

### Legacy string list
```yaml
parents:
  - MSG-...
  - MSG-...
```

### Structured object list
```yaml
parents:
  - msg_id: MSG-...
    kind: depends_on
    meta:
      reason: blocked
```

`Parent` fields:
- `msg_id` (required in practice)
- `kind` (optional, free-form)
- `meta` (optional `map[string]string`)

The parser accepts both forms and converts legacy string entries to `Parent{MsgID: ...}`.

## Link Model
`links` is an optional list of:
- `url` (string)
- `label` (optional string)
- `kind` (optional string)

Notes:
- Current model uses `url`, not `path`.
- Links are advisory; tooling does not enforce link kinds.

## Validation and Normalization Rules
On append (`AppendMessage`):
- `type` must be non-empty.
- `project_id` must be non-empty.
- `msg_id` is always regenerated.
- `ts` is set to current UTC time if zero, otherwise normalized to UTC.
- For `type == "ISSUE"`, empty `issue_id` is auto-filled from `msg_id`.

There is no hardcoded message-type allowlist in message bus core.

## Message ID Contract
`msg_id` format is:
`MSG-YYYYMMDD-HHMMSS-<9-digit nanoseconds>-PID<5-digit pid>-<4-digit seq>`

Example:
`MSG-20260223-191710-184887000-PID67946-0001`

## Backward Compatibility
The reader also accepts legacy single-line records:
`[YYYY-MM-DD HH:MM:SS] TYPE: body`

Legacy lines are converted to synthetic messages with IDs:
`LEGACY-LINE-<line-number>`

## Out of Scope for Current Model
These fields are not in the current `Message` struct and must not be documented as canonical headers:
- `attachment_path`
- `attachments`

## Related Specs
- `docs/specifications/subsystem-message-bus-tools.md`
- `docs/specifications/subsystem-agent-protocol.md`
