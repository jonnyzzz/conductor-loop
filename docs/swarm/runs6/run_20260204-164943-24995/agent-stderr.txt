OpenAI Codex v0.95.0 (research preview)
--------
workdir: /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm
model: gpt-5.2-codex
provider: openai
approval: never
sandbox: danger-full-access
reasoning effort: xhigh
reasoning summaries: auto
session id: 019c298f-4e19-7113-ad82-1e6f0d108c84
--------
user
You are a sub-agent reviewing the swarm design docs after the latest updates.

Read:
- ideas.md
- SUBSYSTEMS.md
- TIPICS.md
- subsystem-*.md
- subsystem-*-QUESTIONS.md
- questions-history/*.md

Also check git history for TIPICS.md and a few subsystem specs/questions (git log -p) to ensure newer answers are reflected.

Task:
- Identify contradictions or missing decisions across ideas.md, specs, and TIPICS.md.
- Identify any answered questions that are still present in *-QUESTIONS.md files (should be removed).
- Identify any missing open questions that should be added.
- Propose concrete spec updates (file -> bullet list).

If you are Claude: use Perplexity MCP to verify any external factual claims. If none, say so.

Output format:
1) External facts check (short)
2) Contradictions/missing decisions
3) Questions to remove/resolve
4) New questions to add
5) Spec updates

Do NOT edit files. Do NOT run tests.

mcp: perplexity starting
mcp: mcp-steroid starting
mcp: playwright starting
mcp: mcp-steroid ready
mcp: perplexity ready
mcp: playwright ready
mcp startup: ready: mcp-steroid, perplexity, playwright

thinking
**Clarifying file edit constraints**

I confirmed the user forbids editing files despite project instructions to write to MESSAGE-BUS.md, so I'll note this conflict but avoid file edits. Next, I'll list and read specified docs and inspect git logs for recent changes on key files.
exec
/bin/zsh -lc ls in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
ISSUES.md
MESSAGE-BUS.md
SUBSYSTEMS.md
TIPICS.md
ideas.md
prompts
questions-history
runs
runs2
runs3
runs4
runs5
runs6
subsystem-agent-backend-claude-QUESTIONS.md
subsystem-agent-backend-claude.md
subsystem-agent-backend-codex-QUESTIONS.md
subsystem-agent-backend-codex.md
subsystem-agent-backend-gemini-QUESTIONS.md
subsystem-agent-backend-gemini.md
subsystem-agent-backend-perplexity-QUESTIONS.md

thinking
**Planning file reading strategy**

I'm preparing to read multiple files in the questions-history directory using rg and sed to efficiently extract and summarize relevant content.
exec
/bin/zsh -lc 'ls questions-history' in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
subsystem-agent-protocol-QUESTIONS-20260202.md
subsystem-message-bus-tools-QUESTIONS-20260202.md
subsystem-monitoring-ui-QUESTIONS-20260202.md
subsystem-runner-orchestration-QUESTIONS-20260202.md
subsystem-storage-layout-QUESTIONS-20260202.md

thinking
**Planning to read key docs**

I'm preparing to read ideas.md, SUBSYSTEMS.md, and TIPICS.md to gather crucial information for the next steps.
exec
/bin/zsh -lc "sed -n '1,200p' ideas.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agentic Swarm Design

We notice that agents are much better to work on a smaller tasks. 
The longer it works, the more prompts we give to it, the harder it turns out
for the agent to pursue the initial attention and goals. 

In this project we approach it from the different angle, here is the agent swarm manifesto:
- agent should do a selected task and exit
- task can be of any kind, from coding, to managing
- we build the work as a chunk of recursive tasks
- on each level an agent must decide if it can work on the task or it should delegate the smaller task down to the hierarchy
- we have monitoring tool and see the actual delegation tree
- for communication, we include the [message-bus](../message-bus-mcp) as the solution
- we may include a dedicated polling service for the message bus post-MVP; in MVP the root agent polls
- message bus helps to track the progress, together with the git history and other artifacts
- agents seem to be quite clumsy with Git, and it means we need to offer Git Pro skills, so it can commit only selected files, without touching other files. Hope it can be done in the upper promts
- we designed the basic schema with ../THE_PROMPT_v5.md and the run-agent binary
- there should be no direct communication with agents, instead, one can only write to message bus
- we need monitoring tool, so we track all agent runs for all projects
- run different agents types each time to keep up the work

thinking
**Planning to read SUBSYSTEMS.md**
exec
/bin/zsh -lc "sed -n '1,200p' SUBSYSTEMS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Subsystems

This list is derived from ideas.md and the subsystem specs (and their QUESTIONS) in this folder.

1. Runner & Orchestration
   - Scope: run-agent binary + run-agent task flow, Ralph restart loop, run linking, idle/stuck handling, agent selection/rotation, stop/kill, run metadata, poller/handler agents.
   - Spec: subsystem-runner-orchestration.md

2. Storage & Data Layout
   - Scope: ~/run-agent layout, run-info.yaml, TASK_STATE/DONE, FACT files, timestamp/run_id format, home-folders.md, retention.
   - Spec: subsystem-storage-layout.md

3. Message Bus Tooling
   - Scope: run-agent bus CLI/REST, YAML front-matter message format, message types/threading, atomic appends, streaming/polling, relationship schema.
   - Spec: subsystem-message-bus-tools.md; subsystem-message-bus-object-model.md

4. Monitoring & Control UI
   - Scope: React UI served by run-agent backend, project/task/run tree, threaded message bus view, live output streaming, task creation UI.
   - Spec: subsystem-monitoring-ui.md


thinking
**Reviewing TIPICS.md**
exec
/bin/zsh -lc "sed -n '1,240p' TIPICS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Topics

This list captures the current planning topics derived from ideas.md, the subsystem specs, and historical Q/A. Topics are intentionally broad and cross-cutting. Each topic includes consolidated decisions and remaining open questions.

1. Message Bus Format & Threading
   - Decisions:
     - Format: append-only YAML front-matter entries separated by `---` (no legacy single-line compatibility).
     - Required headers: msg_id, ts (ISO-8601 UTC; distinct from compact filename timestamps), type, project; optional task/run_id/parents/attachment_path.
     - Types: FACT, QUESTION, ANSWER, USER, START, STOP, ERROR, INFO, WARNING, OBSERVATION, ISSUE.
     - Threading: parents[] links; append-only corrections/updates; parents[] supports string shorthand (implicit reply) or structured objects with explicit relationship kind.
     - Relationship kind values are free-form strings; tooling is permissive in MVP (see subsystem-message-bus-object-model.md).
     - CLI --parents accepts string msg_id lists only; structured parents objects are posted via REST.
     - Atomic writes via run-agent bus (temp + swap); direct writes disallowed.
     - Routing: separate PROJECT-MESSAGE-BUS.md and TASK-MESSAGE-BUS.md; task messages stay in task scope, project messages are project-wide; UI aggregates at read time.
     - Size: soft 64KB body limit; larger payloads stored as attachments in the task folder with timestamp + short description naming and attachment_path metadata.
     - Reader behavior: sequential scan with optional filter/regex; no cursor file.
   - Open questions (see subsystem-message-bus-object-model-QUESTIONS.md, subsystem-message-bus-tools-QUESTIONS.md):
     - Whether cross-scope parents are allowed (task messages referencing project messages) and how UI resolves them.
     - Whether run-agent bus post should return msg_id for chaining.
   - Related: ideas.md, subsystem-message-bus-tools.md, subsystem-agent-protocol.md, subsystem-monitoring-ui.md

thinking
**Planning systematic spec review**

I'm preparing to read multiple subsystem docs and related questions to identify contradictions or missing decisions, starting with the agent protocol spec for a focused, efficient cross-check.
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-protocol.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agent Protocol & Governance Subsystem

## Overview
Defines behavioral rules for all agents in the swarm, including delegation, communication, state/fact updates, and git safety. Enforcement is primarily via prompts and runner tooling, not sandboxing.

## Goals
- Ensure small, focused agent runs that exit on completion.
- Force all communication through message bus tooling.
- Maintain a reliable state/facts trail for handoff.
- Reduce cross-agent conflicts via delegation.

## Non-Goals
- Hard sandbox enforcement or resource limits.
- Strict path boundaries across projects.

## Behavioral Rules
- Agents MUST work on a scoped task and exit when done.
- Agents MUST delegate if a task is too large or outside their folder context.
- Agents SHOULD scope work to a single module/folder and delegate other folders to sub-agents.
- Agents MUST read TASK_STATE.md and message bus on start.
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-protocol-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agent Protocol & Governance - Questions

- Q: When a parent agent delegates to a sub-agent, must the parent block until the child completes, or can it exit and rely on Ralph to manage completion? | Proposed default: Parent blocks to preserve context and return path. | A: TBD.
- Q: When should the system move from root-agent polling to a dedicated message-bus polling service? | Proposed default: Post-MVP, only if message volume or latency requires it. | A: TBD.

thinking
**Starting subsystem environment contract**
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-env-contract.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Environment & Invocation Contract Subsystem

## Overview
Defines the invocation contract between run-agent (Go binary; including `task`/`job`) and spawned agents. This includes internal environment variables used for run tracking, plus the prompt/context injection that agents use to discover paths (task/run folders) without relying on env vars.

## Goals
- Document internal JRUN_* variables for run tracking.
- Document prompt/context injection for run/task paths.
- Clarify that agents should not rely on environment variables for workflow.
- Ensure child processes can find run-agent via PATH.

## Non-Goals
- Standardizing backend token names beyond config injection.
- Enforcing env vars at the OS/sandbox level.
- Providing a full process supervisor API (handled by Runner & Orchestration).

## Responsibilities
- Specify required internal variables and their meanings.
- Define prompt/context injection rules.
- Define read-only vs writable classification for any injected values.
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-env-contract-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Environment & Invocation Contract - Questions

- Q: How are paths normalized in the prompt preamble (OS-native vs POSIX style)? | Proposed default: OS-native using Go filepath.Clean. | A: TBD.
- Q: Does the agent process inherit the full parent environment or a restricted set? | Proposed default: Full inheritance in MVP (no sandbox). | A: TBD.
- Q: What is the signal handling contract between run-agent and agents (SIGTERM propagation, grace period)? | Proposed default: run-agent forwards SIGTERM to the agent process group and waits 30s before SIGKILL. | A: TBD.
- Q: Should the current date/time be injected into the prompt preamble for agents? | Proposed default: Yes, ISO-8601 UTC. | A: TBD.

thinking
**Starting subsystem message bus review**
exec
/bin/zsh -lc "sed -n '1,260p' subsystem-message-bus-object-model.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Message Bus Object Model

## Overview
Defines the object schema for structured message relationships in the message bus. This extends the basic parents[] threading mechanism to support richer dependency semantics ("beads"-style relationships) while remaining backward-compatible with simple parent msg_id lists.

## Goals
- Provide a stable schema for structured parents[] entries.
- Allow richer relationships beyond simple replies (e.g., blocks, supersedes).
- Keep compatibility with string-only parents[] entries.

## Non-Goals
- Defining a full issue-tracking workflow.
- Enforcing relationship semantics at runtime (tooling may remain permissive in MVP).

## parents[] Schema
The `parents` header field accepts either:
- A list of strings (msg_id values), or
- A list of objects with relationship metadata.

### String Form (Shorthand)
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-message-bus-object-model-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Message Bus Object Model - Questions

- Q: Are cross-scope parents allowed (task message referencing project message), and how should the UI resolve them? | Proposed default: Allow; UI resolves across both buses with clear scope labels. | A: TBD.

thinking
**Noting message bus tools**
exec
/bin/zsh -lc "sed -n '1,260p' subsystem-message-bus-tools.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Message Bus Tooling Subsystem

## Overview
Provides the run-agent bus CLI and REST conventions for writing to and reading from project/task message buses. The tooling is implemented in the Go `run-agent` binary. Agents must communicate only through the message bus tooling; direct file writes are disallowed.

## Goals
- Provide a consistent append-only message format.
- Enable blocking or polling reads and streaming.
- Support CLI and REST access via the run-agent binary.

## Non-Goals
- Implementing the message bus service beyond the run-agent binary.
- Backward compatibility with legacy single-line formats.

## Responsibilities
- Define message format and required header fields.
- Define run-agent bus post/poll/stream behavior.
- Define message threading (parents[]), filtering, and ordering rules.

## Interfaces / CLI

thinking
**Noting questions file presence**

I found a questions file related to message-bus-tools, indicating some queries or notes exist for this part of the code.
exec
/bin/zsh -lc "sed -n '1,220p' subsystem-message-bus-tools-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Message Bus Tooling - Questions

- Q: Should `run-agent bus post` return the generated msg_id to stdout/JSON for chaining? | Proposed default: Print msg_id to stdout on success. | A: TBD.

thinking
**Starting subsystem-monitoring-ui review**
exec
/bin/zsh -lc "sed -n '1,260p' subsystem-monitoring-ui.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Monitoring & Control UI Subsystem

## Overview
A TypeScript + React web UI for observing the agent swarm. It is served by the run-agent Go binary (run-agent serve; embedded static assets) and uses the same backend to read the filesystem layout and message bus streams.

## Goals
- Visualize projects, tasks, and run hierarchies from disk layout.
- Display message bus activity in near real-time.
- Show agent output and prompt artifacts per run.
- Provide a guided task creation UI.

## Non-Goals
- Remote multi-user access or authentication (localhost only for MVP).
- Editing task files directly in the UI.
- Full IDE features.
- Multi-host backend selection (planned later).
- Cross-project full-text search across messages and outputs.

## UX Requirements
- Use JetBrains Ring UI as the base UX framework.

thinking
**Listing monitoring questions**
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-monitoring-ui-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Monitoring & Control UI - Questions

- Q: What is the API contract between the Go backend and the UI (REST/JSON schemas, SSE event formats), and how are TypeScript types generated? | Proposed default: REST/JSON + SSE; add OpenAPI or manual type sync later. | A: TBD.
- Q: What is the development workflow for the UI (webpack dev server with proxy vs embedded only)? | Proposed default: webpack-dev-server proxy to Go backend; embed for release. | A: TBD.
- Q: Do we need a state management library (Redux/Zustand) or is React Context sufficient for MVP? | Proposed default: Context + hooks for MVP. | A: TBD.
- Q: How should log streaming be exposed in the backend (per-run SSE endpoint vs polling output.md)? | Proposed default: Per-run SSE when available; polling fallback for MVP. | A: TBD.
- Q: What path validation rules apply to file-read endpoints (e.g., /api/files) to prevent traversal outside ~/run-agent? | Proposed default: filepath.Clean + prefix check against storage root; reject symlinks outside root. | A: TBD.

thinking
**Reviewing subsystem orchestration doc**
exec
/bin/zsh -lc "sed -n '1,260p' subsystem-runner-orchestration.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Runner & Orchestration Subsystem

## Overview
This subsystem owns how agents are started, restarted, and coordinated. It defines the `run-agent` binary (implemented in Go, including the `task` and `job` subcommands) responsible for spawning agent runs, tracking lineage, and enforcing the root "Ralph" restart loop until completion.

## Goals
- Start agents with a consistent run layout and metadata (see Storage & Data Layout).
- Track parent-child relationships and restart chains (previous_run_id).
- Keep the root orchestrator running until the task is done (DONE marker).
- Provide a stable CLI for starting tasks and agents.
- Rotate or auto-select agent types to avoid stalling.

## Non-Goals
- Implementing the message bus itself (handled by Message Bus Tooling).
- Implementing the monitoring UI (handled by Monitoring UI).
- Enforcing strict sandboxing or resource limits (not required yet).

## Responsibilities
- Validate required environment variables for run tracking (internal to runner).
- Create run directories and record run metadata.
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-runner-orchestration-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Runner & Orchestration - Questions

- Q: How are run-agent binary updates/versioning handled in the Go implementation (manual install vs self-update)? | Proposed default: Manual install/rebuild for MVP. | A: TBD.
- Q: Where is the config.hcl schema/version defined and validated? | Proposed default: Embed schema in Go binary; validate on startup. | A: TBD.

thinking
**Starting subsystem storage layout exploration**
exec
/bin/zsh -lc "sed -n '1,260p' subsystem-storage-layout.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 50ms:
# Storage & Data Layout Subsystem

## Overview
Defines the on-disk layout under ~/run-agent for projects, tasks, and individual agent runs. This layout is the source of truth for monitoring, recovery, and auditability.

## Goals
- Provide a predictable, human-readable structure.
- Persist task state, facts, and message bus history.
- Allow reconstruction of run trees from disk without external DB.

## Non-Goals
- Long-term archival or retention policies beyond "keep everything".
- Storing large binary artifacts.

## Responsibilities
- Define directory layout and naming conventions.
- Define file formats for run metadata, facts, and state files.
- Specify how agents read/write state and facts.
- Clarify that config.hcl is global only (no per-project/task config files).


thinking
**Reviewing storage questions file**
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-storage-layout-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Storage & Data Layout - Questions

- Q: Is UTF-8 encoding strictly enforced for all text files (TASK.md, TASK_STATE.md, output.md, logs)? | Proposed default: Yes, strict UTF-8 without BOM. | A: TBD.
- Q: Do we need a schema/version field in run-info.yaml (and similar metadata) to support future layout evolution? | Proposed default: Add `version: 1` to run-info.yaml. | A: TBD.

thinking
**Scanning backend agent specs**
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-backend-codex.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agent Backend: Codex

## Overview
Defines how the Go `run-agent` binary invokes the Codex CLI for a single agent run.

## Goals
- Provide a stable invocation contract for Codex-based runs.
- Capture stdin/stdout/stderr behavior for run artifacts.

## Non-Goals
- Defining prompt content (handled by Runner & Orchestration).
- Managing Codex account setup or billing.

## Invocation (CLI)
- Command (used by run-agent):
  - `codex exec --dangerously-bypass-approvals-and-sandbox -C <cwd> - < <prompt.md>`
- Prompt input is provided via stdin from the run folder prompt file.
- Working directory is set by run-agent based on task/sub-agent context.

## I/O Contract
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-agent-backend-codex-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agent Backend: Codex - Questions

- Q: What environment variable name does the Codex CLI expect for API credentials (e.g., OPENAI_API_KEY), and how should run-agent map config keys to it? | Proposed default: Map OPENAI_API_KEY from config.hcl. | A: TBD.
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-backend-claude.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agent Backend: Claude Code

## Overview
Defines how the Go `run-agent` binary invokes the Claude CLI for a single agent run.

## Goals
- Provide a stable invocation contract for Claude-based runs.
- Capture stdin/stdout/stderr behavior for run artifacts.

## Non-Goals
- Defining prompt content (handled by Runner & Orchestration).
- Managing Claude account setup or billing.

## Invocation (CLI)
- Command (used by run-agent):
  - `claude -p --input-format text --output-format text --tools default --permission-mode bypassPermissions < <prompt.md>`
- Prompt input is provided via stdin from the run folder prompt file.
- Working directory is set by run-agent based on task/sub-agent context.

## I/O Contract
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-agent-backend-claude-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Backend: Claude Code - Questions

- Q: What is the correct CLI flag to enable all tools (e.g., `--tools default` vs `--allowedTools`), and should run-agent mirror `claude --help` output exactly? | Proposed default: Use the flag that enables all tools on the installed CLI (verify with `claude --help` during implementation). | A: TBD.

thinking
**Noting focus on Gemini spec**
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-backend-gemini.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Backend: Gemini

## Overview
Defines how the Go `run-agent` binary invokes the Gemini CLI for a single agent run.

## Goals
- Provide a stable invocation contract for Gemini-based runs.
- Capture stdin/stdout/stderr behavior for run artifacts.

## Non-Goals
- Defining prompt content (handled by Runner & Orchestration).
- Managing Gemini account setup or billing.

## Invocation (CLI)
- Command (used by run-agent):
  - `gemini --screen-reader true --approval-mode yolo < <prompt.md>`
- Prompt input is provided via stdin from the run folder prompt file.
- Working directory is set by run-agent based on task/sub-agent context.

## I/O Contract
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-agent-backend-gemini-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Agent Backend: Gemini - Questions

- Q: What environment variable name does the Gemini CLI expect for API credentials? | Proposed default: GEMINI_API_KEY. | A: TBD.
- Q: Does the Gemini CLI support streaming/unbuffered stdout so the UI can show live progress? | Proposed default: Yes; enforce unbuffered output if supported. | A: TBD.

thinking
**Noting perplexity spec**
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-backend-perplexity.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Backend: Perplexity

## Overview
Defines the native Perplexity backend integration for run-agent. Perplexity is treated as an agent type and invoked via REST API (not CLI wrappers).

## Goals
- Provide a stable adapter for Perplexity-backed agent runs.
- Align prompt/input/output handling with other agent backends.

## Non-Goals
- Defining Perplexity account setup or billing.
- Providing advanced vendor-specific features beyond text completion.

## Invocation (REST)
- run-agent sends a prompt to the Perplexity API using an API key from config.hcl (inline or @file reference).
- The adapter writes the final response to output.md and logs to agent-stderr.txt.
- Adapter should emit periodic progress (or stream tokens if supported) to avoid idle/stuck detection.

## I/O Contract
- Input: prompt text (from prompt.md).
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-agent-backend-perplexity-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Backend: Perplexity - Questions

- Q: Should the Perplexity adapter use streaming responses for liveness/progress updates? | Proposed default: Yes, if supported; otherwise emit periodic progress logs. | A: TBD.
- Q: How should Perplexity citations be represented in output.md? | Proposed default: Append a "References" section after the main response. | A: TBD.
exec
/bin/zsh -lc "sed -n '1,240p' subsystem-agent-backend-xai.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Backend: xAI

## Overview
Defines the placeholder for xAI backend integration. This work is deferred post-MVP.

## Goals
- Capture the intended integration surface for xAI.
- Document the intended future integration path (OpenCode + xAI).

## Non-Goals
- Implementing the xAI adapter before post-MVP work begins.

## Invocation (Planned)
- Use OpenCode agent configured to target xAI models (only if xAI token is provided).
- Default to the best available xAI model when enabled.

## I/O Contract
- Input: prompt text (from prompt.md).
- Output: plain text response captured into output.md.
- Errors: logged to agent-stderr.txt; non-zero exit code for failures.
exec
/bin/zsh -lc "sed -n '1,200p' subsystem-agent-backend-xai-QUESTIONS.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Backend: xAI - Questions

- Q: How will OpenCode be configured to use xAI models when the integration is enabled post-MVP? | Proposed default: Provide a run-agent adapter that passes model/provider flags to OpenCode based on config.hcl. | A: TBD.

thinking
**Advancing to questions-history files**

I'm moving on to the questions-history files to check if answered questions are possibly resolved, building on progress through previous subsystems.
exec
/bin/zsh -lc "sed -n '1,200p' questions-history/subsystem-agent-protocol-QUESTIONS-20260202.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Agent Protocol & Governance - Questions

- Q: How is folder ownership assigned and recorded, and how is it passed to sub-agents?
  Proposed default: Root agent maintains OWNERSHIP.md (path -> owner run_id) and includes owned paths in sub-agent prompts.
  A: There is no OWNDERSHIP.md file. You start `run-agent` command to start sub agent, it manages all the run folders by itself, it adds "RUN_FOLDER=<path>, use this folder for prompts, task outputs, and other temp files. Put the results to $RUN_FOLDER/output.md file" to the beginning of the promots. Together wish base prompts to each runs. So 

- Q: What is the ownership handoff protocol when a parent reassigns paths or a sub-agent finishes?
  Proposed default: Parent posts HANDOFF message to TASK-MESSAGE-BUS with paths + new owner, then updates OWNERSHIP.md and TASK_STATE.md.
  A: Agents are never working with theis paths directly, no need to reassign. There is no OWNDERSHIP.md file.

- Q: Are parent agents allowed to read/monitor child TASK_STATE.md and output during execution?
  Proposed default: Parent may read child TASK_STATE.md/output for monitoring but must not write; all commands via MESSAGE-BUS.
  A: We do not help or block it. It's up the the agent to figure it out.

- Q: Should agents have resource limits (disk writes, network calls, subprocess count), and who enforces them?
  Proposed default: Optional limits defined in config; run-agent enforces pre-flight and logs violations to ISSUES.md.
  A: No. We just run the agent processes.

- Q: What guardrails apply to sensitive paths (~/.ssh, ~/.gnupg, /etc) when no sandbox is enforced?
  Proposed default: Treat as restricted; require explicit user approval via MESSAGE-BUS before read/write; log access.

thinking
**Reviewing unanswered questions**

I confirmed only two questions remain in the current protocol, both regarding parent block vs exit and the poller. None of the other questions are unresolved, so I'll move on to reviewing questions related to message-bus tools.
exec
/bin/zsh -lc "sed -n '1,200p' questions-history/subsystem-message-bus-tools-QUESTIONS-20260202.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Message Bus Tooling - Questions

- Q: What are the required header fields for each message entry, and what is the canonical msg_id format?
  Proposed default: Required: msg_id, ts, type, project; optional: task, run_id, parents[]; msg_id = ULID generated by run-agent bus tooling.
  A: Accepted.

- Q: Should tooling read legacy single-line entries, or require YAML front-matter only?
  Proposed default: Read both; new writes always YAML front-matter; provide optional migration tool.
  A: No need for backward compatibility, this is a new tool anyway. Use the right approach.

- Q: What is the exact concurrency/atomicity strategy for appending messages?
  Proposed default: Advisory file lock + append + fsync for new entries; temp+rename only for compaction.
  A: We base it on the run-agent logic, create a temp file first, next swap files. There is low change of conflict, use OS-provided features.

- Q: What ordering guarantees should bus readers assume when multiple agents append concurrently?
  Proposed default: Timestamp ordering only; ties resolved by msg_id; no global FIFO guarantee.
  A: the ID is timestamp + pid, so it's globally unique. Low probability of collision or conflicts is ok.

- Q: Should poll/pager support cursor persistence (e.g., --cursor-file) or leave it entirely to callers?
  Proposed default: Optional --cursor-file storing last msg_id; default caller-managed.

thinking
**Noting potential spec updates**

Some answers may require updating spec/TIPICS and question files, possibly removing outdated ones; these will be addressed later while moving on to questions-history for monitoring-ui.
exec
/bin/zsh -lc "sed -n '1,200p' questions-history/subsystem-monitoring-ui-QUESTIONS-20260202.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
# Monitoring & Control UI - Questions

- Q: When a user enters a task id that already exists, should the UI attach/restart or create a new task with a suffix?
  A: Prompt user; default to restart/attach; offer "Create new with timestamp suffix".

- Q: In aggregated output views, should stdout/stderr be merged or separated?
  A: Merge chronologically with stream tags and color coding; allow quick filter toggle.

- Q: What is the default log tail size and paging behavior for large outputs?
  A: Show last 1MB (or 5k lines) per run; "Load more" fetches older chunks.

- Q: Should message bodies and prompts render as plain text or Markdown in the UI?
  Proposed default: Plain text for MVP; optional Markdown toggle later.
  A: Plain text with JetBrains mono font.

- Q: How should projects/tasks be ordered in the tree (alphabetical vs last activity)?
  A: Order by last activity (most recent first), with alphabetical tiebreakers.

- Q: Should the UI expose run controls (stop/kill/restart) for run nodes or stay read-only?
  Proposed default: Read-only for MVP; controls added later via backend.

thinking
**Exploring runner orchestration history**
exec
/bin/zsh -lc "sed -n '1,240p' questions-history/subsystem-runner-orchestration-QUESTIONS-20260202.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Runner & Orchestration - Questions

- Q: On Ralph restarts, how are root runs linked for UI and recovery (parent/previous chain)?
  A: Each restart creates a new run; run metadata includes previous_run_id to form a chain.

- Q: What locking mechanism prevents concurrent run-task instances for the same task, and how are stale locks recovered?
  Proposed default: task.lock with PID+start time; stale if PID missing or lock age > TTL; allow --force to clear.
  A: We create runId as current timestamp (date, time) and PID. 

- Q: How does “lucky” agent selection persist state across runs (round-robin index, health/degraded backoff)?
  Proposed default: Store last-used index and degraded backends (from backend health TTL cache) in a per-project runner state file.
  A: Use message bus, query it to decide. Every run should include that information.

- Q: How are message-bus pollers identified, deduplicated, and restarted on crash?
  Proposed default: One poller per project/task with pid+heartbeat file; restart if heartbeat stale; log to MESSAGE-BUS.
  A: No need for that, make sure root agent is taking care of that.

- Q: How should orphaned runs be handled when run-agent exits but the agent process continues?
  Proposed default: On supervisor start, scan PIDs; mark orphan if pid alive but no parent; keep monitoring; if pid dead and no exit_code, mark crashed.
  A: We wait for all children to exit before marking a next start.

thinking
**Noticing spec contradictions**

The history contains some answers but also contradictions with the current specification, prompting a closer analysis before moving on to storage-layout questions.
exec
/bin/zsh -lc "sed -n '1,200p' questions-history/subsystem-storage-layout-QUESTIONS-20260202.md" in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
# Storage & Data Layout - Questions

- Q: What exact timestamp format/timezone should be used for all <timestamp> segments to ensure lexical sort == chronological?
  Proposed default: 
  A: UTC with YYYYMMDD-HHMMSSMMMM-PID (path-safe, sortable; UTC by convention).

- Q: What format should run_id take (ULID/UUIDv7/etc.) and who generates it?
  Proposed default: ULID generated by the runner; used in run folder names and message bus entries.
  A: RunId is generated by run-agent automatically, use UTC with YYYYMMDD-HHMMSSMMMM-PID as sufix

- Q: What are allowed characters/length limits for project IDs and task slugs, and what is the collision strategy?
  Proposed default: slugify to lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash.
  A: Java Identifier rules. No limit on project ID length.

- Q: What is the intended content/producer for output.md vs agent-stdout.txt/agent-stderr.txt, and which should the UI show by default?
  A: output.md is the final agent response; stdout/stderr are raw streams; UI defaults to output.md with a raw-logs toggle.

- Q: What is the write protocol for root-owned files (TASK_STATE.md, OWNERSHIP.md), and should updates be atomic?
  A: Only root agent writes; use temp write + atomic rename; last writer wins.


thinking
**Checking git history for TIPICS.md and subsystems**
exec
/bin/zsh -lc 'git log -p -- TIPICS.md' in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
commit 399147ba79f8388237157607b5ce1d9b99737e3f
Author: Eugene Petrenko <eugene.petrenko@jetbrains.com>
Date:   Wed Feb 4 16:06:50 2026 +0100

    update the specifications

diff --git a/swarm/TIPICS.md b/swarm/TIPICS.md
index 8d2b7a5..d21cf48 100644
--- a/swarm/TIPICS.md
+++ b/swarm/TIPICS.md
@@ -7,13 +7,14 @@ This list captures the current planning topics derived from ideas.md, the subsys
      - Format: append-only YAML front-matter entries separated by `---` (no legacy single-line compatibility).
      - Required headers: msg_id, ts (ISO-8601 UTC; distinct from compact filename timestamps), type, project; optional task/run_id/parents/attachment_path.
      - Types: FACT, QUESTION, ANSWER, USER, START, STOP, ERROR, INFO, WARNING, OBSERVATION, ISSUE.
-     - Threading: parents[] links; append-only corrections/updates.
+     - Threading: parents[] links; append-only corrections/updates; parents[] supports string shorthand or structured objects with relationship kind.
      - Atomic writes via run-agent bus (temp + swap); direct writes disallowed.
      - Routing: separate PROJECT-MESSAGE-BUS.md and TASK-MESSAGE-BUS.md; task messages stay in task scope, project messages are project-wide; UI aggregates at read time.
      - Size: soft 64KB body limit; larger payloads stored as attachments in the task folder with timestamp + short description naming and attachment_path metadata.
      - Reader behavior: sequential scan with optional filter/regex; no cursor file.

thinking
**Planning git log checks on subsystems**

I'm selecting about three subsystem spec or question files to run git log -p on, focusing on message-bus-tools, runner-orchestration, storage-layout, and related QUESTIONS files to confirm that recent answers are up to date.
exec
/bin/zsh -lc 'git log -p -- subsystem-message-bus-tools.md' in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
commit 399147ba79f8388237157607b5ce1d9b99737e3f
Author: Eugene Petrenko <eugene.petrenko@jetbrains.com>
Date:   Wed Feb 4 16:06:50 2026 +0100

    update the specifications

diff --git a/swarm/subsystem-message-bus-tools.md b/swarm/subsystem-message-bus-tools.md
index 41e2db6..62af3a8 100644
--- a/swarm/subsystem-message-bus-tools.md
+++ b/swarm/subsystem-message-bus-tools.md
@@ -25,7 +25,7 @@ Provides the run-agent bus CLI and REST conventions for writing to and reading f
   - --task <id> (optional)
   - --type <FACT|QUESTION|ANSWER|USER|START|STOP|ERROR|INFO|WARNING|OBSERVATION|ISSUE>
   - --message <text> (body)
-  - --parents <msg_id,...> (optional)
+  - --parents <msg_id,...> (optional; structured relationships are supported via REST or future CLI extensions)
 - Agents rely on JRUN_* env vars; error messages must not hint to agents to set env vars.
 
 ### run-agent bus poll
@@ -36,6 +36,7 @@ Provides the run-agent bus CLI and REST conventions for writing to and reading f

thinking
**Reviewing commit history for orchestration docs**
exec
/bin/zsh -lc 'git log -p -- subsystem-runner-orchestration.md' in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
commit 399147ba79f8388237157607b5ce1d9b99737e3f
Author: Eugene Petrenko <eugene.petrenko@jetbrains.com>
Date:   Wed Feb 4 16:06:50 2026 +0100

    update the specifications

diff --git a/swarm/subsystem-runner-orchestration.md b/swarm/subsystem-runner-orchestration.md
index 592da2f..ce13667 100644
--- a/swarm/subsystem-runner-orchestration.md
+++ b/swarm/subsystem-runner-orchestration.md
@@ -1,7 +1,7 @@
 # Runner & Orchestration Subsystem
 
 ## Overview
-This subsystem owns how agents are started, restarted, and coordinated. It defines the `run-agent` binary (and `run-task` subcommand) responsible for spawning agent runs, tracking lineage, and enforcing the root "Ralph" restart loop until completion.
+This subsystem owns how agents are started, restarted, and coordinated. It defines the `run-agent` binary (including the `task` and `job` subcommands) responsible for spawning agent runs, tracking lineage, and enforcing the root "Ralph" restart loop until completion.
 
 ## Goals
 - Start agents with a consistent run layout and metadata (see Storage & Data Layout).
@@ -25,7 +25,7 @@ This subsystem owns how agents are started, restarted, and coordinated. It defin

thinking
**Exploring storage layout history**
exec
/bin/zsh -lc 'git log -p -- subsystem-storage-layout.md' in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 51ms:
commit 399147ba79f8388237157607b5ce1d9b99737e3f
Author: Eugene Petrenko <eugene.petrenko@jetbrains.com>
Date:   Wed Feb 4 16:06:50 2026 +0100

    update the specifications

diff --git a/swarm/subsystem-storage-layout.md b/swarm/subsystem-storage-layout.md
index 1ac9533..2e6c8fb 100644
--- a/swarm/subsystem-storage-layout.md
+++ b/swarm/subsystem-storage-layout.md
@@ -16,6 +16,7 @@ Defines the on-disk layout under ~/run-agent for projects, tasks, and individual
 - Define directory layout and naming conventions.
 - Define file formats for run metadata, facts, and state files.
 - Specify how agents read/write state and facts.
+- Clarify that config.hcl is global only (no per-project/task config files).
 
 ## Directory Layout
 Base root:
@@ -61,6 +62,7 @@ Base root:
   - cwd, prompt_path, output_path, stdout_path, stderr_path

thinking
**Planning git log check for questions file**

Deciding to run git log on a questions file to confirm newer answers are reflected, aiming to cover subsystem-message-bus-tools-QUESTIONS.md as a safety check.
exec
/bin/zsh -lc 'git log -p -- subsystem-message-bus-tools-QUESTIONS.md' in /Users/jonnyzzz/Work/jonnyzzz-ai-coder/swarm succeeded in 52ms:
Total output lines: 661

commit 43e152dd31ddb423b27d38b0080bf44ef1f1cbbd
Author: Eugene Petrenko <eugene.petrenko@jetbrains.com>
Date:   Wed Feb 4 16:18:30 2026 +0100

    include answers

diff --git a/swarm/subsystem-message-bus-tools-QUESTIONS.md b/swarm/subsystem-message-bus-tools-QUESTIONS.md
index b477a18..033e0fe 100644
--- a/swarm/subsystem-message-bus-tools-QUESTIONS.md
+++ b/swarm/subsystem-message-bus-tools-QUESTIONS.md
@@ -1,3 +1,5 @@
 # Message Bus Tooling - Questions
 
-- Q: Should message bus compaction/cleanup be supported (rewrite/compact) or remain strictly append-only in MVP? | Proposed default: Keep append-only in MVP; add an explicit compaction command later with atomic rewrite. | A: TBD.
+- Q: Should message bus compaction/cleanup be supported (rewrite/compact) or remain strictly append-only in MVP? 
+  Proposed default: Keep append-only in MVP; add an explicit compaction command later with atomic rewrite.
+  A: No cleanup is needed. Atomic writes to the file. 


