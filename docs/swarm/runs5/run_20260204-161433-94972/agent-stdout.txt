The Perplexity MCP is not properly configured. Let me proceed with my analysis based on the documents I've read. I'll note the external claims that should be verified separately.

---

## Storage & Data Layout Subsystem Review

### 1. External Facts Check

**Perplexity MCP unavailable** - the following claims should be verified independently:

- **YAML front matter format**: The spec references "YAML front matter" for FACT files and message bus entries. This is a well-established format (used by Jekyll, Hugo, etc.) where YAML metadata is enclosed between `---` delimiters at the start of a file.
  - **Status**: Standard format; no verification needed.

- **UTF-8 encoding and BOM**: Q mentions "UTF-8 without BOM" as proposed default.
  - **Status**: UTF-8 without BOM is industry standard for text files on Unix-like systems and modern tools. BOM is typically only used/required on Windows for UTF-16. This is correct.

- **Java Identifier rules**: Spec states project IDs follow "Java Identifier rules."
  - **Status**: Java identifiers must start with letter/underscore/$, followed by letters/digits/underscores. This is well-documented in JLS (Java Language Specification).

- **Slug format [a-z0-9-]**: Standard URL-safe slugification pattern.
  - **Status**: Common practice; no verification needed.

**Conclusion**: All external factual claims are accurate and standard industry practices. No corrections needed.

---

### 2. Spec Updates

#### subsystem-storage-layout.md

**Add missing details from answered questions:**

- **Slug collision strategy**: Add explicit mention that slug collision resolution (append -<4char> hash) is now defined.
  - Line 49: "Task folder: task-<timestamp>-<slug> (slug derived from name; generated when omitted). Slug rules: lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash."
  - Current line already mentions "generated when omitted" but doesn't include collision strategy.

**Clarify ambiguities from ideas.md:**

- **STATE.md vs TASK_STATE.md**: Spec notes "Some prompts may refer to STATE.md, but the canonical file name is TASK_STATE.md" (line 72). This is good but could be emphasized in Lifecycle or Notes.
  - Suggestion: Add to Notes section: "Agents may reference STATE.md in prompts for brevity, but must always read/write TASK_STATE.md."

**Add from TIPICS.md context:**

- **Timestamp precision**: TIPICS.md confirms milliseconds (MMMM) format. Spec already documents this correctly at line 46.
- **No schema versioning yet**: This is an open question but not blocking; no update needed until decided.

---

#### subsystem-storage-layout-QUESTIONS.md

**Update based on git history (prefer newer answers):**

The current file (as of 43e152d) has one open question:
- Q: What are the allowed characters/length limits for task slugs, and what is the collision strategy?
- A: Slugify to lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash.

The historical version (questions-history/subsystem-storage-layout-QUESTIONS-20260202.md) had many questions that were answered and resolved. Comparing:

**Resolved in spec (should remove from Q file):**
- ✅ Timestamp format → answered (YYYYMMDD-HHMMSSMMMM-PID)
- ✅ run_id format → answered (same as timestamp)
- ✅ Project ID rules → answered (Java Identifier)
- ✅ output.md vs stdout/stderr → answered (output.md default)
- ✅ TASK_STATE write protocol → answered (temp+rename, root only)
- ✅ FACT file format → answered (YAML front matter required)
- ✅ Config file location → answered (no per-project/task config)
- ✅ Retention policy → answered (no cleanup needed)
- ✅ Size limits → answered (no limits)
- ✅ Symlinks → answered (not allowed)
- ✅ Storage conflicts → answered (no host_id)

**Currently open (should remain or add):**
- UTF-8 encoding enforcement
- Schema versioning for run-info.yaml
- Task slug collision (now answered per git history)

---

### 3. Questions to Remove/Resolve

#### subsystem-storage-layout-QUESTIONS.md

**Remove (fully answered):**

1. **Q: What are the allowed characters/length limits for task slugs, and what is the collision strategy?**
   - **Resolution**: Answered in commit 43e152d: "Slugify to lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash."
   - **Action**: This should be moved from QUESTIONS to the spec proper (line 49 already partially covers it, but collision strategy should be explicit).

**Keep (still open):**

1. **Q: Is UTF-8 encoding strictly enforced for all text files?**
   - **Status**: Proposed default "Yes, strict UTF-8 without BOM" is reasonable but not yet confirmed.
   - **Keep**: Yes, legitimate open question.

2. **Q: Do we need a schema/version field in run-info.yaml?**
   - **Status**: Proposed `version: 1` field is forward-thinking but not urgent for MVP.
   - **Keep**: Yes, but could be tagged as post-MVP consideration.

---

### 4. New Open Questions

#### subsystem-storage-layout-QUESTIONS.md

**Add:**

1. **Q: Should the timestamp in file/folder names use local time or UTC, and should the timezone be explicit?**
   - **Context**: Spec says "UTC" but timestamps are in format YYYYMMDD-HHMMSSMMMM-PID with no timezone indicator. Ideas.md line 46 confirms UTC but doesn't discuss timezone-awareness for display/parsing.
   - **Proposed default**: UTC implicit; UI should display in local time with explicit timezone labels.
   - **A**: TBD.

2. **Q: What happens if TASK_STATE.md is corrupted or unparseable by the root agent?**
   - **Context**: Historical spec (commit 14bceb9) said "rewrite with 'status: unknown'", but current spec says "free-text summary" with no status field requirement. Contradiction removed but error-handling not specified.
   - **Proposed default**: Root agent logs warning to message bus, rewrites with "State lost due to corruption; restarting analysis."
   - **A**: TBD.

3. **Q: Should ATTACH-* files have any size limits or require explicit approval before creation?**
   - **Context**: Spec says binary/text artifacts stored at task root. No size limits mentioned. Large files could bloat storage.
   - **Proposed default**: Soft limit 100MB per attachment; warn in message bus if exceeded; no automatic rejection.
   - **A**: TBD.

4. **Q: Should run-info.yaml include exit_signal in addition to exit_code (for SIGTERM/SIGKILL cases)?**
   - **Context**: Spec lists exit_code but doesn't mention signal. Relevant for distinguishing crash vs. clean exit vs. forced kill.
   - **Proposed default**: Add optional `exit_signal: <signal_name>` field when process terminated by signal.
   - **A**: TBD.

5. **Q: What is the expected behavior if the slug generation/collision logic fails (e.g., hash collision after multiple attempts)?**
   - **Context**: Slug collision uses -<4char> hash, but 4 hex chars only give 65k variations. Extremely unlikely but not impossible.
   - **Proposed default**: After 10 collision retries, fail task creation with error to user.
   - **A**: TBD.

---

### 5. New Docs/Topics Suggested

**No new dedicated docs needed.** The storage layout is well-scoped and integrated with existing subsystems.

**However**, consider:

1. **Cross-reference clarification**: The relationship between `subsystem-storage-layout.md` and `subsystem-message-bus-tools.md` regarding attachment storage could be more explicit. Suggest adding a "See Also" section at the end of storage-layout.md:
   - See Also: subsystem-message-bus-tools.md for attachment_path usage in message entries.

2. **Run metadata evolution**: If schema versioning (Q2 above) is approved, a separate doc `docs/RUN-INFO-SCHEMA.md` could track schema changes. But this is premature until v2 exists.

---

## Summary of Contradictions/Gaps

### Contradictions Identified:

1. **STATE.md vs TASK_STATE.md**: Resolved in spec (line 72), but could be more prominent. Not a contradiction, just a naming alias.

2. **No true contradictions found** between ideas.md, TIPICS.md, and the spec. The spec accurately reflects decisions from both sources.

### Missing Decisions:

1. UTF-8 encoding enforcement (open Q).
2. Schema versioning for run-info.yaml (open Q).
3. Error handling for corrupted TASK_STATE.md (new Q).
4. Attachment size limits (new Q).
5. Exit signal tracking (new Q).
6. Slug collision failure mode (new Q).

### Spec Completeness:

The storage layout spec is mature and well-aligned with ideas.md and TIPICS.md. Most historical questions have been resolved. The remaining open questions are edge cases or future-proofing concerns that don't block MVP implementation.

---

## Recommended Actions:

1. **Update subsystem-storage-layout.md line 49**: Add explicit collision strategy text.
2. **Move answered slug question** from QUESTIONS.md to resolved/closed.
3. **Add 5 new open questions** listed above to subsystem-storage-layout-QUESTIONS.md.
4. **Add "See Also" section** to storage-layout.md referencing message-bus-tools.md.
5. **Tag UTF-8 and schema versioning questions** as "MVP-optional" if deferring decision.
