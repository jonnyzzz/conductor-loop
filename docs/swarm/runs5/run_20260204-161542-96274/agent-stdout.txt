The Perplexity MCP is not configured. Let me proceed with the review based on my knowledge (as of January 2025).

## Review Output

### 1) External Facts Check

**Unable to verify via Perplexity MCP** (authentication not configured). Based on my knowledge cutoff (January 2025):

✓ **Timestamp format `YYYYMMDD-HHMMSSMMMM-PID`**: Path-safe (no special characters), lexically sortable. Standard practice.

✓ **Atomic writes via temp + rename**: Standard POSIX pattern for atomic file updates. Correct approach for TASK_STATE.md.

✓ **HCL (Hashicorp Configuration Language)**: Valid config format. Used by Terraform, Vault, etc. Good choice for structured config.

✓ **SSE vs WebSocket**: SSE is simpler for server-to-client streaming, one-way communication. WebSocket is bidirectional. SSE with polling fallback is a reasonable MVP choice.

✓ **YAML front matter**: Standard format used in static site generators (Jekyll, Hugo), markdown processors. Valid convention.

**No factual errors identified** in the specifications based on available knowledge.

---

### 2) TIPICS Updates

**Topic 3: Storage Layout & Metadata**

#### Add to Decisions:
- Task slug collision strategy now defined: lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash.
- Clarify that TASK_STATE.md canonical name (some prompts reference STATE.md but TASK_STATE.md is correct).

#### Update Open Questions section:
- **REMOVE**: "Task slug rules and collision strategy" (now answered and in spec)
- **KEEP**: UTF-8 enforcement and metadata schema versioning (still TBD)

**Proposed TIPICS.md section 3 update:**
```markdown
3. Storage Layout & Metadata
   - Decisions:
     - Layout rooted at ~/run-agent/<project>/task-<timestamp>-<slug>/runs/<run_id>/ with config.hcl at ~/run-agent/.
     - run-info.yaml is canonical run metadata (lower-case keys).
     - TASK_STATE.md is free text; DONE is completion marker; TASK_STATE updates use temp+rename (root only).
     - Timestamp precision is milliseconds (MMMM) in `YYYYMMDD-HHMMSSMMMM-PID`.
     - Task folder naming: task-<timestamp>-<slug>; slug rules: lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash.
     - output.md is the final agent response; stdout/stderr are raw streams; UI defaults to output.md with raw log toggle.
     - FACT files require YAML front matter; home-folders.md is YAML with explanations.
     - Message bus stored as single append-only file per scope; no rotation/cleanup yet.
     - No symlinks/hardlinks; no host_id segmentation; no size limits enforced.
   - Open questions (see subsystem-storage-layout-QUESTIONS.md):
     - UTF-8 enforcement for text files.
     - Metadata schema versioning for run-info.yaml.
   - Related: ideas.md, subsystem-storage-layout.md, subsystem-runner-orchestration.md
```

---

### 3) Spec Updates

#### **subsystem-storage-layout.md**

**Line 49: Add clarity to task slug rules**
- Current: "Task folder: task-<timestamp>-<slug> (slug derived from name; generated when omitted). Slug rules: lowercase [a-z0-9-], max 48 chars; on collision append -<4char> hash."
- **OK as-is** (already includes collision strategy from recent answer)

**Line 71: Clarify TASK_STATE.md naming**
- Current mentions "Some prompts may refer to STATE.md, but the canonical file name is TASK_STATE.md."
- **OK as-is** (already clarified)

**Add section on UTF-8 and encoding (pending decision):**
- **Proposed addition** (after line 121, in Notes section):
```markdown
- Text file encoding is expected to be UTF-8; enforcement strategy TBD (see QUESTIONS).
```

**Add section on versioning (pending decision):**
- **Proposed addition** to run-info.yaml section (after line 65):
```markdown
- Schema versioning strategy TBD; consider adding `version: 1` field (see QUESTIONS).
```

#### **subsystem-runner-orchestration.md**

**Line 119: Cross-reference storage layout for run-info.yaml details**
- Current lists run-info.yaml fields inline
- **Suggestion**: Add note "(See subsystem-storage-layout.md for full run-info.yaml schema)"

**No other spec changes needed** - the orchestration spec correctly references storage layout decisions.

---

### 4) Questions to Remove/Resolve

#### **subsystem-storage-layout-QUESTIONS.md** (current file)

**Question 1: UTF-8 enforcement**
- Q: Is UTF-8 encoding strictly enforced for all text files (TASK.md, TASK_STATE.md, output.md, logs)? | Proposed default: Yes, strict UTF-8 without BOM. | A: TBD.
- **STATUS**: Keep open (not answered)
- **Resolution summary**: N/A (still open)

**Question 2: Schema versioning**
- Q: Do we need a schema/version field in run-info.yaml (and similar metadata) to support future layout evolution? | Proposed default: Add `version: 1` to run-info.yaml. | A: TBD.
- **STATUS**: Keep open (not answered)
- **Resolution summary**: N/A (still open)

#### **questions-history/subsystem-storage-layout-QUESTIONS-20260202.md** (historical)

All questions in the historical file have been **resolved** and incorporated into TIPICS.md and subsystem-storage-layout.md:

1. **Timestamp format** → Resolved: UTC YYYYMMDD-HHMMSSMMMM-PID (TIPICS line 39)
2. **run_id format** → Resolved: Same as timestamp format (subsystem-storage-layout.md line 47)
3. **Project ID / task slug rules** → Resolved: Java Identifier for project; slug rules defined (subsystem-storage-layout.md line 49; TIPICS line 39)
4. **output.md vs stdout/stderr** → Resolved: output.md is final response; UI defaults to output.md (TIPICS line 40)
5. **TASK_STATE.md write protocol** → Resolved: temp + atomic rename (TIPICS line 38; subsystem-storage-layout.md line 69-70)
6. **FACT file headers** → Resolved: YAML front matter required (subsystem-storage-layout.md line 78-79)
7. **Per-project/task config files** → Resolved: Not needed; only global config.hcl (subsystem-storage-layout.md line 19)
8. **Retention policy** → Resolved: No cleanup required yet (subsystem-storage-layout.md line 110)
9. **Size limits** → Resolved: No limits enforced (subsystem-storage-layout.md line 115; TIPICS line 42)
10. **Symlinks/hardlinks** → Resolved: Not allowed (subsystem-storage-layout.md line 113; TIPICS line 42)
11. **Host_id segmentation** → Resolved: Not needed; runs under project/task only (subsystem-storage-layout.md line 114; TIPICS line 42)

**All historical questions are resolved** - no action needed on the historical file.

---

### 5) New Open Questions

#### **subsystem-storage-layout-QUESTIONS.md**

**NEW Q1: Slug generation algorithm details**
- Q: What exact algorithm should be used to derive slug from task name (Unicode normalization, whitespace handling, invalid character replacement)?
- Proposed default: NFD normalization, lowercase, replace whitespace and invalid chars with `-`, trim leading/trailing `-`, collapse consecutive `-`.
- A: TBD

**NEW Q2: Attachment lifecycle and cleanup**
- Q: Should attachments (ATTACH-* files) be cleaned up when their referencing message bus entry is older than N days, or kept indefinitely?
- Proposed default: Keep indefinitely in MVP; add retention policy post-MVP.
- A: TBD

**NEW Q3: DONE file content**
- Q: Should DONE file remain empty, or include a final status/timestamp for human readability?
- Proposed default: Empty marker file (simpler); final status is in output.md and message bus.
- A: TBD

**NEW Q4: run-info.yaml commandline field format**
- Q: Should the `commandline` field in run-info.yaml be a string or array (argv-style)?
- Proposed default: Array for correct quoting/escaping; string as fallback if array construction is difficult.
- A: TBD

**NEW Q5: Multiple run-agent instances per task**
- Q: If multiple `run-agent task` commands are invoked concurrently for the same task, should there be explicit detection/warning, or rely on filesystem atomicity?
- Proposed default: No explicit locking; timestamp+PID ensures unique run_id; both Ralph loops may coexist (last-writer-wins for TASK_STATE.md).
- A: TBD

**Retain existing Q1 and Q2** (UTF-8 enforcement, schema versioning) - still open.

---

## Summary

- **External facts**: No factual errors found in specs (could not verify via Perplexity MCP due to auth issue).
- **TIPICS updates**: Add task slug collision rules to decisions; update open questions to remove resolved items and add UTF-8/versioning.
- **Spec updates**: Minor clarifications needed for UTF-8 encoding expectations and schema versioning notes; all major decisions are already captured.
- **Resolved questions**: All 11 questions from historical file are resolved and incorporated.
- **New questions**: 5 new open questions proposed for edge cases and implementation details not yet specified.
