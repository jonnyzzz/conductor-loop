# Message Bus Tooling Subsystem

## Overview
Provides the run-agent bus CLI and REST conventions for writing to and reading from project/task message buses. Agents must communicate only through the message bus tooling; direct file writes are disallowed.

## Goals
- Provide a consistent append-only message format.
- Enable blocking or polling reads and streaming.
- Support CLI and REST access via the run-agent binary.

## Non-Goals
- Implementing the message bus service beyond the run-agent binary.
- Backward compatibility with legacy single-line formats.

## Responsibilities
- Define message format and required header fields.
- Define run-agent bus post/poll/stream behavior.
- Define message threading (parents[]), filtering, and ordering rules.

## Interfaces / CLI
### run-agent bus post
- Purpose: append a message entry.
- Inputs (human CLI args override env vars):
  - --project <id>
  - --task <id> (optional)
  - --type <FACT|QUESTION|ANSWER|USER|START|STOP|ERROR|INFO|WARNING|OBSERVATION|ISSUE>
  - --message <text> (body)
  - --parents <msg_id,...> (optional)
- Agents rely on JRUN_* env vars; error messages must not hint to agents to set env vars.

### run-agent bus poll
- Purpose: read new messages.
- Args:
  - --project <id>
  - --task <id> (optional)
  - --since <timestamp> (optional)
  - --since-id <msg_id> (optional)
  - --filter <type|regex> (optional, linear scan)
- No cursor file; caller manages last seen id.

### run-agent bus stream (HTTP)
- REST/SSE stream for UI:
  - GET /api/bus/stream?project=<id>&task=<id>
- No auth (localhost only in MVP).
- Same parameters as CLI; text streaming is preferred.
- Hosted by run-agent serve (shared with UI backend).

## Message Format
Append-only YAML front-matter entries separated by `---`:

---
msg_id: <unique id>
ts: <ISO-8601 UTC>
type: <TYPE>
project: <project_id>
task: <task_id>
run_id: <run_id>
parents: [<msg_id>, ...]
attachment_path: <optional path>
---
<message body>

### Required Header Fields
- msg_id, ts, type, project

### Optional Header Fields
- task, run_id, parents[], attachment_path

### msg_id Format
- Generated by run-agent.
- Must be unique and lexically sortable.
- Recommended: timestamp + PID (ULID-like). If multiple messages are emitted in the same tick, append a per-process sequence to avoid collisions.

### Timestamp Note
- Header `ts` uses ISO-8601 UTC.
- File and folder names use the compact timestamp format defined in Storage & Data Layout.

## Message Types
Canonical types:
- FACT, QUESTION, ANSWER, USER
- START, STOP
- ERROR, INFO, WARNING
- OBSERVATION, ISSUE

## Threading & Corrections
- Messages are append-only; no in-place edits.
- Use parents[] to reference prior messages (answers, corrections, updates).
- UI collapses or threads entries by parents[].

## Ordering Guarantees
- Timestamp ordering only; ties resolved by msg_id.
- No strict global FIFO across concurrent writers.

## Concurrency / Atomicity
- run-agent bus writes via temp file + atomic swap.
- Direct file writes are disallowed.
- If a write is partial/corrupt, the tooling recovers and continues.

## Size Limits & Attachments
- Soft limit: 64KB per message body.
- Larger payloads stored as files with attachment_path metadata.

## Compaction / Archival
- No compaction/rotation strategy yet; files can grow.

## Routing
- Task messages stay in TASK-MESSAGE-BUS.md.
- Project bus is not mirrored; UI aggregates at read time.
