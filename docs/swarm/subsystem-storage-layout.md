# Storage & Data Layout Subsystem

## Overview
Defines the on-disk layout under ~/run-agent for projects, tasks, and individual agent runs. This layout is the source of truth for monitoring, recovery, and auditability.

## Goals
- Provide a predictable, human-readable structure.
- Persist task state, facts, and message bus history.
- Allow reconstruction of run trees from disk without external DB.

## Non-Goals
- Long-term archival or retention policies beyond "keep everything".
- Storing large binary artifacts.

## Responsibilities
- Define directory layout and naming conventions.
- Define file formats for run metadata, facts, and state files.
- Specify how agents read/write state and facts.
- Clarify that config.hcl is global only (no per-project/task config files).

## Directory Layout
Base root:

~/run-agent/
  config.hcl
  <project>/
    PROJECT-MESSAGE-BUS.md
    home-folders.md
    FACT-<timestamp>-<name>.md
    task-<timestamp>-<slug>/
      TASK.md
      TASK_STATE.md
      DONE
      TASK-MESSAGE-BUS.md
      TASK-FACTS-<timestamp>.md
      ATTACH-<timestamp>-<name>.<ext>
      runs/
        <run_id>/
          run-info.yaml
          prompt.md
          output.md
          agent-stdout.txt
          agent-stderr.txt

## Naming Conventions
- Timestamp format (UTC): `YYYYMMDD-HHMMSSMMMM-PID`.
- run_id: same format as timestamp (generated by run-agent).
- Project ID: Java Identifier rules; no length limit.
- Task folder: task-<timestamp>-<slug> (slug derived from name; generated when omitted).
- FACT files: FACT-<timestamp>-<name>.md.
- Task facts: TASK-FACTS-<timestamp>.md.
- Attachments: ATTACH-<timestamp>-<name>.<ext> stored in the task folder.

## File Formats
### run-info.yaml
- YAML with lower-case keys.
- Required fields:
  - run_id, project_id, task_id
  - parent_run_id, previous_run_id
  - agent, pid, pgid
  - start_time, end_time, exit_code
  - cwd, prompt_path, output_path, stdout_path, stderr_path
- Optional fields:
  - backend_provider, backend_model, backend_endpoint (no secrets).
  - commandline (full command used to start the agent).

### TASK_STATE.md
- Free-text summary maintained by root agent.
- Short, current status only (not a log).
- Written by root agent only; update via temp write + atomic rename.
- Some prompts may refer to STATE.md, but the canonical file name is TASK_STATE.md.

### DONE
- Empty marker file created by root agent when task is complete.
- Deleting DONE restarts the Ralph loop on next run.

### FACT-*.md and TASK-FACTS-*.md
- YAML front matter required:
  - created_at, scope (task|project), run_id, title
- Body is Markdown.

### ATTACH-*.ext
- Binary or text artifacts stored at task folder root.
- attachment_path in message bus entries is relative to the task folder.
- Names use the canonical timestamp + short description: ATTACH-<timestamp>-<name>.<ext>.

### home-folders.md
- YAML format:
  - project_root
  - source_folders[]
  - additional_folders[]
- Each folder entry includes a short text explanation.

## Message Bus Storage
- Single append-only file per scope:
  - PROJECT-MESSAGE-BUS.md
  - TASK-MESSAGE-BUS.md
- Format managed by run-agent bus tooling (see Message Bus Tooling).
- No rotation/compaction yet; allow growth.
- Message attachments referenced by attachment_path live in the task folder (see Attachments naming).

## Lifecycle
- Project directory created on first task creation.
- Task directory created by run-agent task.
- Run directory created by run-agent per execution.
- Facts are appended by creating new FACT files.
- TASK_STATE.md overwritten by root agent each cycle.

## Retention / Cleanup
- No cleanup or pruning required yet.

## Constraints
- Symlinks/hardlinks inside the storage tree are not allowed.
- No host_id segmentation; runs live under project/task only.
- No size limits enforced for output.md, TASK_STATE.md, or FACT files.

## Notes
- UI reads only from this layout + message bus files.
- Message bus start/stop events live in the bus, not separate logs.
- UI defaults to output.md; raw stdout/stderr are available via a log toggle.
